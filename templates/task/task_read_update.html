{% load static %}

<form method="post" action="{% url 'task:task-update' task.pk %}?next={{ next }}"
      novalidate
      class="h-100 w-100 d-flex flex-column justify-content-center btn-on-change">
  {% csrf_token %}

  <div class="card shadow-sm border-0 h-100">
    <div class="card-body p-4 text-center align-content-center">

      <h4 class="mb-4 text-secondary">
        <a href="{{ next }}" class="btn btn-outline-secondary"><i class="bi bi-box-arrow-up-left"></i></a>
        <i class="user-select-none">Task name</i>
        <button type="button"
                class="btn btn-outline-danger"
                hx-get="{% url 'task:task-delete' task.pk %}"
                hx-target="#modal-content"
                data-bs-toggle="modal"
                data-bs-target="#modal-container">
          <i class="bi bi-trash3"></i>
        </button>
      </h4>

      <div class="mb-4">
        {% if form.name.errors %}
          <div class="alert alert-danger" role="alert">
            {{ form.name.errors }}
          </div>
        {% endif %}

        <div class="d-flex justify-content-center mb-3" id="task-status-container">
          {% include "task/partials/task_status_badge.html" %}
        </div>

        <fieldset {% if task.is_completed %}disabled{% endif %} style="border: none; padding: 0; margin: 0;">
          {{ form.name }}
        </fieldset>
      </div>

      <fieldset {% if task.is_completed %}disabled{% endif %} style="border: none; padding: 0; margin: 0;">

        <div class="row g-3 mb-3">
          <div class="col-md-4 toggle-block">
            <div class="p-2 border rounded bg-light text-center h-100 d-flex align-items-center justify-content-center cursor-pointer">
              {% if form.deadline.errors %}
                <div class="alert alert-danger" role="alert">incorrect date</div>
              {% endif %}
              <div class="text-muted w-100">
                <div class="user-select-none"><i class="bi bi-calendar-x me-1"></i> Deadline:</div>
                <div class="open_after_click w-100 p-2">{{ form.deadline }}</div>
              </div>
            </div>
          </div>

          <div class="col-md-4 toggle-block">
            <div class="p-2 border rounded bg-light text-center h-100 d-flex align-items-center justify-content-center">
              <div class="text-muted w-100">
                <div class="user-select-none"><i class="bi bi-flag me-1"></i> Priority</div>
                <div class="open_after_click w-100 p-2">{{ form.priority }}</div>
              </div>
            </div>
          </div>

          <div class="col-md-4 toggle-block">
            <div class="p-2 border rounded bg-light text-center h-100 d-flex align-items-center justify-content-center">
              <div class="text-muted w-100">
                <div class="user-select-none"><i class="bi bi-tag me-1"></i> Type</div>
                <div class="w-100 p-2">{{ form.task_type }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3 toggle-block">
          <div class="p-3 border rounded bg-light text-muted">
            <div class="user-select-none"><i class="bi bi-card-text me-2"></i> Description</div>
            <div class="p-2">{{ form.description }}</div>
          </div>
        </div>

        <div class="mb-4 toggle-block">
          <div class="hide_on_click p-2 border rounded bg-light text-center text-muted" role="button">
            <i class="bi bi-person-fill-gear me-2"></i> View/Set assignees
          </div>
          <div class="d-none open_after_click p-3 border rounded bg-white">
            <p class="small text-muted mb-2">Team members:</p>
            {{ form.assignees }}
          </div>
        </div>
      </fieldset>

      {% if not task.is_completed %}
        <div class="d-flex justify-content-center gap-2 border-top pt-3 appear-on-change d-none">
          <button type="submit" class="btn btn-primary px-4">Update</button>
          <button type="button" class="btn btn-outline-secondary px-4 btn-cancel">Cancel</button>
        </div>
      {% else %}
        <div class="text-muted small mt-3">
          <i class="bi bi-info-circle"></i> Task is completed and cannot be edited.
        </div>
      {% endif %}

    </div>
  </div>
</form>

<div id="modal-container" class="modal fade" tabindex="-1">
  <div class="modal-dialog" id="modal-content"></div>
</div>