{% extends "base.html" %}
{% load static %}

{% block header %}
  {{ profile_user.username }} | Profile
{% endblock %}

{% block content %}
  <div class="container">

    <div class="card border-0 shadow-lg overflow-hidden mb-4 rounded-4">
      <div style="height: 140px; background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%); opacity: 0.9;"></div>

      <div class="card-body px-4 px-md-5 position-relative">
        <div class="d-md-flex align-items-end justify-content-between">
          <div class="d-flex align-items-end mb-4 mb-md-0" style="margin-top: -40px;">
            <div class="avatar-circle-lg border border-4 border-white shadow bg-dark fs-1">
              {{ profile_user.first_name|first|upper }}{{ profile_user.last_name|first|upper }}
            </div>
            <div class="ms-3 mb-2">
              <h2 class="fw-bold mb-0 text-dark">{{ profile_user.first_name }} {{ profile_user.last_name }}</h2>
              <p class="text-muted mb-0">
                <i class="bi bi-at"></i>{{ profile_user.username }}
                {% if profile_user.position %} â€¢
                  <span class="text-primary fw-bold">{{ profile_user.position.name }}</span>{% endif %}
              </p>
            </div>
          </div>
          {% if user.id == profile_user.id %}
            <div class="mb-3">
              <a href="{% url 'task:settings' %}" class="btn btn-outline-secondary rounded-pill px-4">
                <i class="bi bi-pencil-square me-2"></i>Edit Profile
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="row g-4">

      <div class="col-lg-4">

        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-bold text-uppercase text-muted small mb-3">Contact Information</h6>
            <div class="d-flex align-items-center mb-3">
              <div class="bg-light p-2 rounded-circle me-3 text-primary">
                <i class="bi bi-envelope"></i>
              </div>
              <div>
                <small class="d-block text-muted">Email Address</small>
                <span class="fw-bold text-dark">{{ profile_user.email }}</span>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <div class="bg-light p-2 rounded-circle me-3 text-primary">
                <i class="bi bi-building"></i>
              </div>
              <div>
                <small class="d-block text-muted">Department</small>
                <span>{{ profile_user.position.name|default:"General Staff" }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-0 pt-4 pb-2">
            <h6 class="fw-bold text-uppercase text-danger small mb-0">
              <i class="bi bi-crosshair me-2"></i>Priority Focus
            </h6>
          </div>
          <div class="card-body pt-0">
            {% if high_tasks %}
              <div class="d-flex flex-column gap-3">
                {% for task in high_tasks %}
                  <div
                      class="p-3 bg-light rounded-3 border-start border-4 {% if task.priority == 'HIGH' %}border-danger{% else %}border-warning{% endif %} position-relative">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                                    <span class="badge bg-white text-dark border shadow-sm rounded-pill small mb-1">
                                        {{ task.task_type.name|default:"Task" }}
                                    </span>
                      {% if task.deadline %}
                        <small class="text-danger fw-bold" style="font-size: 0.75rem;">
                          <i class="bi bi-clock me-1"></i>{{ task.deadline|date:"M d" }}
                        </small>
                      {% endif %}
                    </div>
                    <h6 class="fw-bold text-dark mb-1 text-truncate">{{ task.name }}</h6>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-center py-4 bg-light rounded-3 dashed-border">
                <i class="bi bi-check-circle fs-1 text-success opacity-50 mb-2"></i>
                <p class="text-muted small mb-0">All clear! No high tasks.</p>
              </div>
            {% endif %}
          </div>
        </div>

        {% if colleagues %}
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h6 class="fw-bold text-uppercase text-muted small mb-3">Team Members</h6>
              <div class="d-flex flex-wrap gap-2">
                {% for colleague in colleagues %}
                  <div class="d-flex align-items-center bg-light px-3 py-2 rounded-pill border col position-relative"
                       title="{{ colleague.first_name }} {{ colleague.last_name }}">
                    <i class="bi bi-person-circle text-secondary me-2"></i>
                    <span class="small fw-bold user-select-none">
                      <a href="{% url 'task:profile' colleague.id %}"
                         class="stretched-link text-decoration-none text-black">
                      {{ colleague.username }}
                        </a>
                    </span>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}

      </div>

      <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-white py-3 border-0">
            <h5 class="fw-bold mb-0">Recent Activity</h5>
          </div>
          <div class="card-body d-flex flex-column justify-content-center mb-40">
            {% if recent_activities %}
              <div class="timeline">
                {% for task in recent_activities %}
                  <div class="timeline-item pb-4 ps-4 position-relative border-start border-2 border-light">
                    <div class="timeline-dot position-absolute start-0 top-0 translate-middle rounded-circle border border-white
                                     {% if task.is_completed %}bg-success{% else %}bg-warning{% endif %}"
                         style="width: 16px; height: 16px; margin-top: 5px;"></div>

                    <div class="timeline-content">
                      <div class="d-flex justify-content-between mb-1">
                        {% if task.is_completed %}
                          <span class="badge bg-success bg-opacity-10 text-success rounded-pill text-white">
                            <i class="bi bi-check2 me-1"></i>Completed Task
                          </span>
                        {% else %}
                          <span class="badge bg-warning bg-opacity-10 text-warning rounded-pill text-white">
                            <i class="bi bi-hourglass-split me-1"></i>In Progress
                          </span>
                        {% endif %}

                        <small class="text-muted">ID: #{{ task.id }}</small>
                      </div>

                      <h6 class="fw-bold text-dark mb-1">
                        {{ task.name }}
                      </h6>

                      <p class="text-muted small mb-2">{{ task.description|truncatewords:15 }}</p>

                      <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-light text-secondary border">
                          <i class="bi bi-tag me-1"></i>{{ task.task_type.name }}
                        </span>
                        {% if task.priority == 'HIGH' %}
                          <span class="badge bg-danger text-white border border-danger">
                            <i class="bi bi-exclamation-circle me-1"></i>High Priority
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}

                <div class="timeline-item ps-4 position-relative">
                  <div
                      class="timeline-dot position-absolute start-0 top-0 translate-middle bg-light rounded-circle border"
                      style="width: 12px; height: 12px; margin-top: 5px;"></div>
                  <p class="text-muted small">Viewing last 5 active items.</p>
                </div>
              </div>
            {% else %}
              <div class="text-center py-5">
                <i class="bi bi-journal-x fs-1 text-muted opacity-50 mb-3"></i>
                <p class="text-muted">No recent activity recorded yet.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
      .timeline-item:last-child {
          border-left: 0 !important;
      }

      .hover-primary:hover {
          color: #0d6efd !important;
          transition: color 0.2s;
      }

      .last-no-border:last-child {
          border-bottom: none !important;
          margin-bottom: 0 !important;
          padding-bottom: 0 !important;
      }

      .avatar-circle-lg {
          width: 100px;
          height: 100px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
      }

      .dashed-border {
          border: 2px dashed #dee2e6;
      }

      .mb-40 {
          padding-bottom: 80px;
      }
  </style>
{% endblock %}